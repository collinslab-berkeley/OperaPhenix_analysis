# Opera Phenix data analysis
Jupyter notebook for counting GFP+/mCherry+ cells from Opera Phenix high-content imaging screens.

### Basic use
Modify input files in the jupyter notebook (as seen below). Each csv contains data for one replicate.
```
# read in data
rep1 = pd.read_csv('2023.8.4 S1P1R1 objects.csv')
rep2 = pd.read_csv('2023.8.4 S1P1R2 objects.csv')
rep3 = pd.read_csv('2023.8.4 S1P1R3 objects.csv')

data = pd.concat([rep1,rep2,rep3]).reset_index(drop=True)
```
Input csv files (one per replicate) contain data values for the following fields: 'Row', 'Column', 'Field', 'Object No', 'siRNA target', 'Replicate', 'GFP intensity', and 'mCherry intensity'

Input csv files were generated by Revvity Harmony 4.9 imaging software. Hoechst-positive cell nuclei were identified and masked using Harmony’s nuclei finding algorithm method C, and then total pixel intensity for each of the eGFP and mCherry channels were measured for each masked nucleus. Each entry in the csv corresponds to a single masked nucleus.

### Overview of algorithm
The goal of this analysis is to identify GFP+ or mCherry+ cells by identifying a "background distribution" of negative cells for each channel and imaging field. Given that strongly fluorescence positive cells make it difficult to fit a Gaussian distribution to the background directly, we employ an iterative approach to identify and fit the background.

First, the median fluorescence intensity for each channel within an imaging field is computed. The distribution of fluorescence intensities below the median value for the field is then reflected over the median to generate a symmetric distribution. A Gaussian is then fit to this symmetric distribution, from which mean and standard deviation values are extracted. Next, a threshold value of µ + 2σ (from this first Gaussian fit) is computed. Fluorescence intensity values in the original distribution below the µ + 2σ threshold value for that field are then taken to fit a second Gaussian distribution, which we define as the background distribution. Finally, cells with fluorescence intensities 3 standard deviations above the mean of this background distribution are categorized as GFP+ or mCherry+ and cells with intensities below that value are categorized as negative.

### Output
The notebook outputs a csv with % of cells marked as GFP+ or mCherry+ per replicate and siRNA target in the code below:
```
# merge dataframes and export to file

out_df = pd.merge(GFP_df,mCherry_df)
out_df.to_csv('out.csv',index=False)
```
The output csv contains the following fields: 'target', 'replicate', 'GFP_mean', 'GFP_std', 'mCherry_mean', and 'mCherry_std', where the mean and standard deviation of % FP+ across calculated across the four imaging fields per replicate.

The code also generates and saves plots with the background distribution fits for visual inspection. The following line can be commented out to disable saving plots or it can be modified to change the output destination if desired:
```fig.savefig('%s_%s.png' % (fluor,target))```
